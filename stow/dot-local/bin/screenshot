#!/usr/bin/env bash

base_folder="$HOME/Pictures/screenshots/$( date '+%Y-%m-%d')"
file_name="$(date '+%H-%M-%S')_screenshot.png"

tmp="/tmp/screenshot.png"

hyprpicker -r -z &

function cleanup {
    pkill hyprpicker
}

trap cleanup EXIT

sleep 0.1

select_region=`hyprctl clients -j | jq -r ".[] | select(.workspace.id == "$(hyprctl activewindow -j | jq -r '.workspace.id')\)""| jq -r ".at,.size" | jq -s "add" | jq '(length / 4 | ceil) as $num_chunks | range(0; $num_chunks) as $i | .[4 * $i : 4 * $i + 4]' | jq -r '"\(.[0]),\(.[1]) \(.[2])x\(.[3])"'| slurp`

if [[ $? = 1 ]]; then
    exit 0
fi

args=($@)
for ((i=0; i <= ${#args[@]}; i++)); do
    case ${args[i]} in
        "--save")
            base_folder="$(fd -td . $HOME | rofi -dmenu)"
            base_folder="${base_folder::-1}"
            if [[ "$base_folder" = "" ]]; then
                exit 0
            fi
        ;;
        "--file-name")
            file_name="$(echo '' | rofi -dmenu -l 0 -p 'Type a file name')"
            if [[ "$file_name" = "" ]]; then
                exit 0
            fi
        ;;
    esac
done

file_path="${base_folder}/$file_name"

sleep 0.2

grim -g "$select_region" "$tmp"

if [[ -f $tmp ]]; then
    if [[ -f "$file_path" ]]; then
        increment=`find "$base_folder" -wholename "$file_path*" | wc -l`
        file_path=$file_path$increment
    fi

    cat $tmp | wl-copy
    mkdir -p ${base_folder}
    mv $tmp $file_path
fi


